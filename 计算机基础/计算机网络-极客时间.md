# 网络协议

高级编程语言也是符合协议的三要素的。

**协议三要素**

- **语法**，就是这一段内容要符合一定的规则和格式。例如，括号要成对，结束要使用分号等。
- **语义**，就是这一段内容要代表某种意义。例如数字减去数字是有意义的，数字减去文本一般来说就没有意义。
- **顺序**，就是先干啥，后干啥。例如，可以先加上某个数值，然后再减去某个数值。



**网购案例**

在浏览器中购物，期间使用到HTTP协议。

```http
HTTP/1.1 200 OK
Date: Tue, 27 Mar 2018 16:50:26 GMT
Content-Type: text/html;charset=UTF-8
Content-Language: zh-CN

<!DOCTYPE html>
<html>
<head>
<base href="https://pages.kaola.com/" />
<meta charset="utf-8"/> <title>网易考拉3周年主会场</title>
```

上面报文的情况：

- 语法，即组织格式，请求的行、头、体
- 语义，状态 200，表述的网页成功返回
- 顺序，先浏览器发HTTP请求，再得到内容

浏览器都是按照指定的协议确定内容进行任务的。



1. 在浏览器中输入URL

2. 通过DNS缓存或者DNS | HTTPDNS 服务器查找域名对应的IP地址

3. 得到IP地址后，浏览器开始打包请求（使用HTTP或者HTTPS协议）

   > 以上是应用层封装，封装后，浏览器会将应用层的包交给下一层去完成，通过 socket 编程来实现。
   >
   > 下一层是传输层。有两种协议，一种是无连接的协议 UDP，一种是面向连接的协议 TCP。对于支付来讲，往往使用 TCP 协议。所谓的面向连接就是，TCP 会保证这个包能够到达目的地。如果不能到达，就会重新发送，直至到达。

4. 传输层添加客户端应用进程和目标服务器应用进程所在端口。

   > 操作系统往往通过端口来判断，它得到的包应该给哪个进程。
   >
   > 传输层封装完毕后，浏览器会将包交给**操作系统的网络层**。
   >
   > 网络层的协议是 IP 协议。在 IP 协议里面会有源 IP 地址和目标 IP 地址。

5. 操作系统根据IP地址判断是否是局域网地址

   > 操作系统启动的时候，就会被 DHCP 协议配置 IP 地址，以及默认的网关的 IP 地址 192.168.1.1。

6. 操作系统通过ARP 协议获取本地网关MAC地址，通过本机网卡将数据帧发给网关

7. 网关（路由器）拆解数据帧，通过MAC地址确定该数据帧是否是自己收，是的情况下，根据路由表中的网段，封装数据包并决定数据帧从哪个网口发出

   > 路由器之间的沟通遵循***路由协议**，常用的有 OSPF 和 BGP。
   >
   > 数据包可以通过网关决定是使用局域网内部的MAC地址还是使用下一跳路由的MAC地址来包装数据包。

8. 数据包到达目标IP地址所在的网段的网关后，根据目标IP对应的主机的MAC地址将数据帧发给目标主机

9. 目标主机解析MAC地址后校验是否是给自己的，是，再发送给操作系统的网络层

10. 目标主机网络层校验IP地址，是，然后将其交给传输层

11. 传输层对于收到的每个包，都会有一个回复的ACK确认包

> 如果过一段时间还是没到，发送端的 TCP 层会重新发送这个包，还是上面的过程。

12. 数据包到达传输层，解析端口号，可以找到正在监听这个端口号的进程

![img](https://static001.geekbang.org/resource/image/a3/9e/a35e16acd0912ae3e79567ca0358df9e.jpg?wh=4456*4699)



> 电商网站的进程得到 HTTP 请求的内容，知道了要买东西，买多少。往往一个电商网站最初接待请求的这个 Tomcat 只是个接待员，负责统筹处理这个请求，而不是所有的事情都自己做。例如，这个接待员要告诉专门管理订单的进程，登记要买某个商品，买多少，要告诉管理库存的进程，库存要减少多少，要告诉支付的进程，应该付多少钱，等等。
>
> 如何告诉相关的进程呢？往往通过 RPC 调用，即远程过程调用的方式来实现。远程过程调用就是当告诉管理订单进程的时候，接待员不用关心中间的网络互连问题，会由 RPC 框架统一处理。RPC 框架有很多种，有基于 HTTP 协议放在 HTTP 的报文里面的，有直接封装在 TCP 报文里面的。
>
> 当接待员发现相应的部门都处理完毕，就回复一个 HTTPS 的包，告知下单成功。这个 HTTPS 的包，会像来的时候一样，最终进入浏览器，显示支付成功。



中间设计的网络协议

![image-20221004204910159](D:\学习笔记\计算机基础\images\image-20221004204910159.png)



问题：当数据帧到达路由器后，可以通过路由表得到下一个路由器的 IP 地址，直接通过 IP 地址找就可以，为什么还要通过本地的 MAC 地址呢？

> ip是网络层使用的 mac是链路层使用的 ip包最终还是要通过物理链接和mac地址进行交互。



补充：

> 1. mac地址是唯一的，为什么可以修改? mac地址全球唯一，它是固化在网卡里的。但网卡毕竟是个硬件，需要软件支持，既操作系统识别。**操作系统识别出来的mac地址是可以更改的**，它只不过是一个字符串。我们常说的修改mac指的是修改电脑中记录的既注册表中的记录。
> 2. 有了mac地址为什么还要有ip地址。mac好比人的身份id，ip好比他的住址，住址可以变，人的id不会变。



**网络分层**

二层（链路层）设备、三层（网络层）设备、四层 LB 和七层 LB ，各层使用的协议和协议的作用。

TCP 在进行三次握手的时候，IP 层和 MAC 层对应都有什么操作？

> TCP 发送每一个消息，都会带着 IP 层和 MAC 层。因为，TCP 每发送一个消息，IP 层和 MAC 层的所有机制都要运行一遍。而你只看到 TCP 三次握手，其实，IP 层和 MAC 层为此也忙活好久。

数据包在路由之间传输的时候，处理目标IP地址，下一跳路由的IP地址如何存放在数据包中？

二层设备处理的包里，有没有 HTTP 层的内容？

通过 SSH 登录到公有云主机里面，都需要经历哪些过程？

打开一个电商网站，都需要经历哪些过程？

**复杂的程序都要分层。**

![img](https://static001.geekbang.org/resource/image/5c/76/5c00f6e610f533d17fb4ad7decacc776.jpg?wh=3226*3472)



**只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。**

> 一个 HTTP 协议的包经过一个二层设备，二层设备收进去的是整个网络包。这里面 HTTP、TCP、 IP、 MAC 都有。什么叫二层设备呀，就是只把 MAC 头摘下来，看看到底是丢弃、转发，还是自己留着。那什么叫三层设备呢？就是把 MAC 头摘下来之后，再把 IP 头摘下来，看看到底是丢弃、转发，还是自己留着。



查看本机IP地址的命令：在 Windows 上是 ipconfig，在 Linux 上是 ifconfig。

Linux 上其他查看 IP 地址的命令： ip addr。













