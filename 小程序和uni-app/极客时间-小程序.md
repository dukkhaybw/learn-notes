语言和技术都是为产品服务的，没有哪种技术或者语言是最好的，也不偏重于某一门语言或技术，只要在当前的时代对某些领域的产品开发是合适的，就可以去学习和使用。

1. 在实践中学习，知行合一
2. 优先学会一门语言，其他语言触类旁通
3. 不要只是看和听，必须敲代码，复原代码和运行效果



## 为什么学习小程序开发

小程序的优势：

1. 与App对比的下载安装体验
2. 与Web对比的启动和运营体验，H5页面每次打开都需要重新下载和渲染，而小程序可以从后台直接切换到前台，渲染上可以像App一样局部渲染



**学习小程序的难点**

小程序组件和接口如何使用

具体的软件中实现具体的某些功能（如：单击头像侧滑菜单如何实现，多个商品分类实现横向滚动）







## 工具、原理与实践

第一章：工具安装，项目创建，小程序的运行原理等。

第九章：补充一些第三方框架的内容，扩展学习



### 小程序运行机制

在小程序诞生之前，最成熟的混合App开发技术是Hybrid，Hybrid的优势：

1. 跨平台
2. 热更新
3. 类原生app的交互体验

Hybrid原理：

它是由native通过JSBridge等方法，提供统一的底层API，然后用html+css实现界面，JS实现业务逻辑。JS调用底层API和后端接口，最后的页面在webview中渲染展示。

在这种模式下，安卓和ios的底层API有一致性，所以可以跨平台开发。

微信小程序相当于运行在微信这个特定环境下的Hybrid技术。



#### 运行机制

微信小程序的双线程运行机制。

![image-20230206132120519](../%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%92%8Cuni-app/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4-%E5%B0%8F%E7%A8%8B%E5%BA%8F.images/image-20230206132120519.png)

逻辑层和视图层分开，他们通过微信底层的WeixinJSBridge进行通信。像在小程序js代码中使用的setData，改变视图层绑定的数据，在底层其实对应执行的是evaluateJavaScript这个函数。

当视图层的交互事件触发了，由视图层向逻辑层传递事件信息时，也是通过evaluateJavaScript进行，evaluateJavaScript的参数是文本，每次调用都需要进行原始类型到文本再到原始类型的转，并且是单通道的，不像golang，c++那样的并发线程特征。所以该evaluateJavaScript方法非常慢。有时小程序页面卡顿，其实不是页面卡，大概率是底层的evaluateJavaScript函数执行效率地下导致。

理解小程序的双线程的通讯机制，可以优化小程序性能。



从4个方面介绍小程序的运行机制和创新点。



小程序的启动机制

小程序有两种启动机制：

1. 冷启动
   用户首次打开小程序或者是小程序被微信主动销毁后再次打开，这是小程序需要重新加载并启动，这就是冷启动。
2. 热启动
   假如用户已经打开过某个小程序，一段时间内再次打开，此时不需要重新启动，只需要将后台状态的小程序切换到前台，这个过程就是热启动



**小程序从本地读取缓存后，当小程序有版本更新时，什么时候可以应用最新的小程序版本？**

小程序冷启动时，如果发现有新的版本，将会异步下载新版本的代码包，并同时用客户端本地缓存的上一次的小程序代码包进行启动，而新版本的小程序则在下一次冷启动时才会被使用。如果想马上使用最新版本的小程序，可以使用wx.getUpdateManager接口处理。





#### 小程序的启动情况

![image-20230204225705996](./极客时间-小程序.assets/image-20230204225705996.png)



#### 小程序的销毁

小程序被主动销毁的情况：

1. 当小程序进入后台，在后台维持运行超过一定时间（目前大概5分钟），就会被微信主动销毁
2. 当短时间内（目前为5秒），连续两次以上收到系统内存的警告，微信就会对小程序进行一个主动销毁，这时一般会收到一条提示语：”运行内存不足，请重新打开小程序。“  单击确定后，小程序直接退出，不利于用户体验。必要时可以使用wx.onMemoryWarning接口监听内存的告警事件，提前做一些处理。



#### 小程序的状态

与小程序冷、热启动相关的，是小程序的两种状态： 

1. 前台状态，小程序启动后界面展示给用户，这时就是前台状态，到用户点击右上角胶囊按钮关闭小程序或者离开微信返回手机桌面，小程序并不会完全终止运行，它还可以运行一段时间，只是进入后台状态。当用户再次进入微信并打开小程序时，小程序则从后台切换到前台状态。（小程序在一定时间内可以从后台直接切换到前台——热启动）
2. 后台状态



#### 双线程架构

为了安全和管控，小程序使用双线程架构执行：**视图线程和逻辑线程**。 

- View 视图线程 
  
- App Service 逻辑线程

他们通过微信底层的WeixinJSBridge进行通信。

![image-20230206195031041](/Users/wuyi/Desktop/study-note/小程序和uni-app/极客时间-小程序.assets/image-20230206195031041.png)

**小程序视图的持续更新如何实现的？**

简单来说，是通过setData实现。

![image-20230206203232787](/Users/wuyi/Desktop/study-note/小程序和uni-app/极客时间-小程序.assets/image-20230206203232787.png)

在Hybrid native中是如何执行JS代码的，webView通过调用evaluateJavaScript，执行了一段字符串形式的JS代码，其中的方法名可以是我们自定义的JS方法名。通过这种方式执行了一段JS代码，并且在执行后，还可以通过回调函数得到JS代码执行后的返回内容。

小程序中底层也是通过evaluateJavaScript方法实现。在小程序中视图层和逻辑层的数据传输实际上是通过底层的WeixinJSBridge，通过原生的evaluateJavaScript实现。

setData要更新的数据，首先会将该数据转化为字符串，接着将字符串与代码拼接成一个JS脚本，最后将拼接的的内容传给evaluateJavaScript原生方法执行，视图更新也采用了虚拟DOM上的优化，所以从数据到视图层的更新并不是实时进行的。



**使用setData可能遇到的问题？**

由于视图线程和逻辑线程彼此分离，两个线程之间通过setData方法驱动的数据交换还要通过WeixinJSBridge中转给底层的evaluateJavaScript方法，这个中转效率低下。

有时，安卓小程序用户在进行界面滑动时，感到页面卡顿，这是因为视图线程一直在进行渲染，逻辑层发送的更新请求就会被阻塞。阻塞达到200毫秒以上就有卡顿的感觉。

**卡顿和更新频率和更新数据量（使用setData更新大数据量列表或者更新体积很大的图片时）也有关系。** 



在IOS系统中，小程序的页面是由多个WKWebView组成，在系统内存紧张时，一部分WKWebView会被系统回收，也就是曾经打开的小程序页面将清楚历史记录，无法回退。



**微信为什么使用WXS这门类似JS的语言来开发？**

WXS（WeiXinScript）是微信打造的一套小程序脚本语言，它结合WXML可以构建页面的组件结构，它不依赖于运行时的基础库版本，可以在所有版本的小程序中运行，它和JS是不同的语言，有自己的语法，并不和JS一致。

![image-20230206203247447](/Users/wuyi/Desktop/study-note/小程序和uni-app/极客时间-小程序.assets/image-20230206203247447.png)

微信团队声称在IOS中，WXS会比JS快2～20倍，这是因为WXS虽然也是代码，但是它并不运行在小程序的逻辑线程中，而是运行在视图线程中，它直接操作视图数据，避免了跨线程的通信开销。因为小程序的双线程架构在数据更新上有瓶颈，所以微信设计了一个WXS视图脚本。

WXS虽然可以提高视图数据的更新效率，但是也不是没有缺陷的，它的问题有：

1. WXS运行环境和其他JS代码是隔离，WXS不能调用其他JS代码里定义的函数，也不能调用小程序提供的以wx开头的API接口。
2. WXS函数不能作为视图模版中的事件回调句柄（比如，上面的tools模版中的函数bar不能作为wxml的标签的事件处理函数绑定到元素上使用）。
3. 由于运行环境的差异，在IOS中WXS会比JS快2～20倍，但是在安卓上两者执行效率基本相同。





#### 视图线程的实现

![image-20230206204357441](/Users/wuyi/Desktop/study-note/小程序和uni-app/极客时间-小程序.assets/image-20230206204357441.png)



#### 小程序页面主要生命周期函数

![image-20230206205236528](/Users/wuyi/Desktop/study-note/小程序和uni-app/极客时间-小程序.assets/image-20230206205236528.png)



![image-20230206205258935](/Users/wuyi/Desktop/study-note/小程序和uni-app/极客时间-小程序.assets/image-20230206205258935.png)



#### 微信开发者工具









## 基础

第二章：小程序组件介绍和使用

第三章：开发常用API介绍和使用





## 项目实践

第四章：小程序前端页面

![image-20230206193859727](/Users/wuyi/Desktop/study-note/小程序和uni-app/极客时间-小程序.assets/image-20230206193859727.png)



第五章：基于nodejs开发后端接口，公众号页面管理后台



第六章：云开发常用功能介绍和使用



第七章：添加广告和流量变现



第八章：添加日常运营插件

